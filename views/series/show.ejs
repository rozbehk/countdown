<%- include('../partials/header') %>

<div class="show-top">
  <div>
    <img
      class="show-poster"
      src="<%= `https://image.tmdb.org/t/p/w500${serie.poster_path}`%>"
      alt=""
    />
  </div>
  <div class="show-details">
    <div class="name-top"><h3><%=serie.name %></h3></div>
    <div>
      <h3>counter</h3>
    </div>
    <div class="rate-wish">
      <div>
        <p>Rate : <%=serie.vote_average%></p>
      </div>
      <div>
        <% if(user.seriesList.find(element => element.toString() ==
        serie._id.toString())){%>
        <form
          action="/user/<%= serie._id %>?_method=DELETE"
          method="POST"
          name="serie"
        >
          <input type="hidden" name="ref" value="Series" />
          <button class="detail-btn">Remove From Wish List</button>
        </form>
        <% }else { %>
        <form action="/user/<%= serie._id%>?_method=PUT" method="POST">
          <input type="hidden" name="ref" value="Series" />
          <button class="detail-btn">Add To The Wish List</button>
        </form>
        <% } %>
      </div>
    </div>
    <div>
      <div>
        <p>Overview:</p>
        <p><%=serie.overview%></p>
      </div>
      <div><p>Total Episodes: <%=serie.number_of_episodes%></p></div>
      <div><p>Total Seasons: <%=serie.number_of_seasons%></p></div>
    </div>
  </div>
</div>

<div class="seasons-detail">
  <div>
    <% serie.seasons.slice().reverse().forEach(function(season, seasonIndex){ %>
    <h2><%=`Season ${season.season_number}`%></h2>
    <% season.episode.forEach(function(episode, episodeIndex){ %>
    <div class="episode-wrapper">
      <div class="episode-detail">
        <%= `Episode ${episode.episode_number} : ${episode.name}` %>
      </div>
      <div class="episode-detail">
        <%= new Date(episode.air_date).toDateString() %>
      </div>
      <div class="episode-detail">
        <div
          class="countdown"
          data-date="<%= episode.air_date %>"
          id="countdown-s<%= season.season_number %>-e<%= episode.episode_number %>"
        >
          <!-- Countdown will be inserted here by JavaScript -->
        </div>
      </div>
    </div>
    <% }) %> <% }) %>
  </div>
</div>

<script>
  // Countdown function for multiple countdowns
  function initCountdowns() {
    const countdownElements = document.querySelectorAll(".countdown");

    countdownElements.forEach((element) => {
      const dateString = element.getAttribute("data-date");

      // Check if date exists and is valid
      if (
        !dateString ||
        dateString === "null" ||
        dateString === "undefined" ||
        dateString.trim() === ""
      ) {
        element.innerHTML = '<div class="no-date">Date Not Available</div>';
        element.setAttribute("data-countdown-disabled", "true");
        return;
      }

      const targetDate = new Date(dateString).getTime();

      // Check if date is valid
      if (isNaN(targetDate)) {
        element.innerHTML = '<div class="no-date">Date Not Available</div>';
        element.setAttribute("data-countdown-disabled", "true");
        return;
      }

      let intervalId;

      function updateCountdown() {
        // Check if disabled
        if (element.getAttribute("data-countdown-disabled") === "true") {
          if (intervalId) clearInterval(intervalId);
          return;
        }

        const now = new Date().getTime();
        const distance = targetDate - now;

        if (distance < 0) {
          element.innerHTML = '<div class="aired">Already Aired</div>';
          element.setAttribute("data-countdown-disabled", "true");
          if (intervalId) clearInterval(intervalId);
          return;
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor(
          (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
        );
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        element.innerHTML = `
                <div class="countdown-display">
                    <span>${days}d</span>
                    <span>${hours}h</span>
                    <span>${minutes}m</span>
                    <span>${seconds}s</span>
                </div>
            `;
      }

      updateCountdown();
      intervalId = setInterval(updateCountdown, 1000);
    });
  }

  // Initialize when page loads and stop any other countdown scripts
  document.addEventListener("DOMContentLoaded", function () {
    // Clear any existing intervals (nuclear option)
    const highestId = setTimeout(() => {});
    for (let i = 0; i < highestId; i++) {
      clearInterval(i);
    }

    initCountdowns();
  });
</script>
<%- include('../partials/footer') %>
